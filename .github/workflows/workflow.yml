name: Airflow Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy_airflow:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Add Helm Repo
      run: |
        helm repo add apache-airflow https://airflow.apache.org
        helm repo update

    - name: Upgrade Airflow
      run: |
        helm upgrade airflow apache-airflow/airflow --namespace default -f values.yaml

    - name: Port Forwarding
      run: |
        kubectl port-forward svc/airflow-webserver 8181:8080 &
        sleep 10
        curl http://localhost:8181
